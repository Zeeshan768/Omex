<!DOCTYPE html>
<html lang="en">

<head>
  <title>Fetch API</title>
  <!-- CSS only -->
  <script src="./table2excel.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="mx-auto w-75 p-3 row alert alert-primary">
    <div class="d-flex p-2 bd-highlight">
      <div class="mx-auto">
        <input name="url" value="https://qa.omexsystems.com/omexwebsrv/api/msd/FindSymbolsByListShort" id="url" placeholder="url" type="text" 
          class=" w-45 p-1 form-control" />
      </div>
      <div class="mx-auto">
        <input name="ssid" value="7,5,9" id="ssid" placeholder="SSID" type="text" placeholder="Enter SSID"
          class=" w-45 p-1 form-control" />
      </div>
      <div class="mx-auto">
        <input name="secid" value="FB,AAPL,FB" id="secid" placeholder="SECID" type="text" placeholder="Enter SECID"
          class="w-45 p-1 form-control " />
      </div>
      <div class="mx-auto">
        <input type="text" name="currency" id="currency" placeholder="Currency" value="USD,USD,USD"
          class="w-45 p-1 form-control" />
      </div>
      
 <!-- _________________For download Excel and pdf icons as image and submit button________ -->     <button  id="btn" type="text" onClick="fetchData()" class="mw-100 btn mx-auto btn-success ">submit</button>
      <div hidden id="demo">
        <img class="icon btn-close-green" onclick="excel()" width="20px" height="20px" src="./pngegg.png" id="downloadexcel" alt="excel icon" title="Download as excel file">
        <img class="icon" width="20px" height="20px" src="./pngwing.com.png" onclick="pdf()" id="downloadpdf"  title="Download as pdf file" alt="pdf icon" class="
        form-control">
      </div>
    </div>

  </div>
  <table id="table" class="w-75 table mx-auto table-success table-striped table-sortable">

  </table>
  <div>
  </div>
  <div hidden id="spinner"></div>


</body>
<script type="text/javascript">
  $(document).ready(function () {
     // Set div display to block
    // $("#btn").click(function () {
    //   $("#demo").show();
    //   // showbutton();
    // });
    
  });
  
  var url;
  var ssidList;
  var secidList;
  var currencyList;
  var body;
  var list;

  const spinner = document.getElementById("spinner");
  const demo = document.getElementById("demo");
  async function fetchData() {
   
    const ssid = document.getElementById("ssid").value;
    const secid = document.getElementById("secid").value;
    const currency = document.getElementById("currency").value;
    ssidList = ssid.split(",");
    secidList = secid.split(",");
    currencyList = currency.split(",");
    // console.log(ssidList, secidList, currencyList);
    body = JSON.stringify(
      ssidList.map((item, index) => ({
        SSID: item,
        SECId: secidList[index],
        Currency: currencyList[index],
      }))
    );
    if (ssid === "" || secid === "" || currency === "") {
      alert("Enter SSID SECID and Currency");
    } else {
      constructTable();
      spinner.removeAttribute("hidden");
      demo.setAttribute("hidden","");
    }
  }
  async function fetchList(body) {
    var url = document.getElementById("url").value;
    const response = await fetch(
          url,
      {
        method: "POST",
        body: body,
        headers: {
          "Content-type": "application/json; charset=UTF-8",
        },
      }
    ); 
 
    const data = await response.json();
    return data;
  }
  function constructHeader(list) {
    var header = $("<tr></tr>");
    for (var key in list) {
      header.append("<th>" + key + "</th>");
    }
    $("thead").append(header);
  }

  function constructBody(list) {
    for (var j = 0; j < list.length; j++) {
      var row = $("<tr></tr>");

      for (var key in list[j]) {
        // console.log(key);
        row.append("<td>" + list[j][key] + "</td>");
      }
      $("tbody").append(row);
      
    }
  }
  // function showbutton() {
  //   // get the element you want to add the button to
  //   var myDiv = document.getElementById("demo");
  //   var button = document.createElement("div");
  //   button.innerHTML = `<img class="icon btn-close-green" onclick="excel()" width="20px" height="20px" src="./pngegg.png" id="downloadexcel" alt="excel icon" title="Download as excel file">
  //        <img class="icon" width="20px" height="20px" src="./pngwing.com.png" onclick="pdf()" id="downloadpdf"  title="Download as pdf file" alt="pdf icon" class="
  //        form-control">`;
  //   myDiv.appendChild(button);
  // }


  function constructSearch() {
    $("thead").append(`<tr id="search">
          <td>
            <input
             class="text-center w-75 p-1"
              type="text"
              id="myInput0"
              onkeyup="myFunction(this, 0)"
              title="Type"
              placeholder="SSID"
            />
          </td>
          <td>
            <input
            class="text-center w-75 p-1"
              type="text"
              id="myInput1"
              onkeyup="myFunction(this, 1)"
              title="Type"
              placeholder="SECId"
            />
          </td>
          <td>
            <input
              type="text"
              class="text-center w-75 p-1"
              id="myInput2"
              onkeyup="myFunction(this, 2)"
              title="Type"
              placeholder="Currency"
            />
          </td>
          <td>
            <input
              type="text"
              class="text-center w-45 p-1"
              id="myInput3"
              onkeyup="myFunction(this, 3)"
              title="Type"
              placeholder="msd_name"
            />
          </td>
          <td>
            <input
              type="text"
              class="text-center w-75 p-1"
              id="myInput4"
              onkeyup="myFunction(this, 4)"
              title="Type"
              placeholder="SECId48"
            />
          </td>
          <td>
            <input
              type="text"
              class="text-center w-75 p-1"
              id="myInput5"
              onkeyup="myFunction(this, 5)"
              title="Type"
              placeholder="SECId48Value"
            />
          </td>
          <td>
            <input
              type="text"
              class="text-center w-75 p-1"
              id="myInput6"
              onkeyup="myFunction(this, 6)"
              title="Type"
              placeholder="Country"
            />
          </td>
        </tr>`);
  }

  async function constructTable() {

    document.getElementById(
      "table"
    ).innerHTML = `<thead id="tbl" class="tab text-center" ></thead><tbody  id="tbl2" class="tab text-center"></tbody>`;
    list = await fetchList(body);
    constructHeader(list[0]);
    constructSearch();
    constructBody(list);
    demo.removeAttribute("hidden","");
    spinner.setAttribute("hidden","");
    
    // showbutton();

    function sortTableByColumn(table, column, asc = true) {
      const dirModifier = asc ? 1 : -1;
      const tBody = table.tBodies[0];
      const rows = Array.from(tBody.querySelectorAll("tr"));

      // Sort each row
      const sortedRows = rows.sort((a, b) => {
        const aColText = a.querySelector(`td:nth-child(${column + 1})`).textContent.trim();
        const bColText = b.querySelector(`td:nth-child(${column + 1})`).textContent.trim();

        return aColText > bColText ? (1 * dirModifier) : (-1 * dirModifier);
      });

      // Remove all existing TRs from the table
      while (tBody.firstChild) {
        tBody.removeChild(tBody.firstChild);
      }

      // Re-add the newly sorted rows
      tBody.append(...sortedRows);

      // Remember how the column is currently sorted
      table.querySelectorAll("th").forEach(th => th.classList.remove("th-sort-asc", "th-sort-desc"));
      table.querySelector(`th:nth-child(${column + 1})`).classList.toggle("th-sort-asc", asc);
      table.querySelector(`th:nth-child(${column + 1})`).classList.toggle("th-sort-desc", !asc);
    }

    document.querySelectorAll(".table-sortable th").forEach(headerCell => {
      headerCell.addEventListener("click", () => {
        const tableElement = headerCell.parentElement.parentElement.parentElement;
        const headerIndex = Array.prototype.indexOf.call(headerCell.parentElement.children, headerCell);
        const currentIsAscending = headerCell.classList.contains("th-sort-asc");

        sortTableByColumn(tableElement, headerIndex, !currentIsAscending);
      });
    });
  }

  let filters = ["", ""];

  function myFunction(thisInput, thisIndex) {
    filters[thisIndex] = thisInput.value.toUpperCase();

    filterTable();
  }



  function filterTable() {
    var table = document.getElementById("table");
    var rows = Object.values(table.getElementsByTagName("tr"));

    for (var rowItr = 2; rowItr < rows.length; rowItr++) {
      var row = rows[rowItr];
      var cells = Object.values(row.getElementsByTagName("td"));

      var isRowVisible = filters.every((filter, filterIndex) => {
        var cell = cells[filterIndex];
        var txtValue = cell.textContent || cell.innerText;

        return filter === "" || txtValue.toUpperCase().indexOf(filter) > -1;
      });

      row.style.display = isRowVisible ? "" : "none";
    }
  }
</script>
 <!-- ________________For download Excel start_____Button at line 31 ________ --> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
  function excel() {
    var data = document.getElementById("table");
    document.getElementById("table").deleteRow(1);
    var fp = XLSX.utils.table_to_book(data, { sheet: 'MMM' });
    XLSX.write(fp, {
      bookType: 'xlsx',
      type: 'base64'
    });
    XLSX.writeFile(fp, 'test.xlsx');
    var tableRef = document.getElementById('table').getElementsByTagName('thead')[0];
    var newText = document.getSelection(constructSearch());
    newCell.append(newText);
  }

</script>
<!-- ________________For download Excel end_____________ -->








<!-- ...............for download pdf ....Button is at line 30..... -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.22/pdfmake.min.js"></script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
<script type="text/javascript">
  $("body").on("click", "#downloadpdf", function () {
    document.getElementById("table").deleteRow(1);
    html2canvas($("#table")[0], {
      onrendered: function (canvas) {
        var data = canvas.toDataURL();
        var docDefinition = {
          content: [{
            image: data,
            width: 500
          }]
        };
        pdfMake.createPdf(docDefinition).download("Table.pdf");
        var tableRef = document.getElementById('table').getElementsByTagName('thead')[0];
        var newText = document.getSelection(constructSearch());
        newCell.insertRow(newText);
      }
    });
  });
</script>
<!-- ...............for download pdf  end....Butto is at line 30..... -->

</html>
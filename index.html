<!DOCTYPE html>
<html lang="en">

<head>
  <title>Fetch API</title>
  <!-- CSS only -->
  <script src="./table2excel.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css" />
</head>

<body>
  <div class="form">
    <div class="title">Welcome</div>
    <div class="subtitle">Let's Fetch Your Desire data!</div>
    <div class="row row1">
      <div class="input-container ic1">
        <input name="ssid" value="7,5,9" id="ssid" placeholder="SSID" class="input first" type="text"
          placeholder="Enter SSID" />
        <div class="cut">SSID</div>
      </div>
      <div class="input-container ic2">
        <input name="secid" value="FB,AAPL,FB" id="secid" placeholder="SECID" class="input" type="text"
          placeholder="Enter SECID" />
        <div class="cut">SECID</div>
      </div>
      <div class="input-container ic2">
        <input type="text" name="currency" id="currency" value="USD,USD,USD" placeholder="Enter" class="input" />
        <div class="cut cut-short">CURRENCY</div>
      </div>
      <button type="text" onClick="fetchData()" class="submit">submit</button>
    </div>
  </div>
  <table id="table" class="styled-table">
    <thead></thead>

    <tbody></tbody>
  </table>
  <button type="text" id="downloadexcel" class="submit"> <img class="image" src="./pngegg.png" alt=""> Download as excel</button>
  <button type="text"  id="downloadpdf" onclick="generate()" class="submit" value="Export To PDF"><img class="image" src="./pngwing.com.png" alt=""> Download as pdf</button>
  <div hidden id="spinner"></div>
</body>
<script type="text/javascript">
  var ssidList;
  var secidList;
  var currencyList;
  var body;
  var list;
  const spinner = document.getElementById("spinner");
  async function fetchData() {
    const ssid = document.getElementById("ssid").value;
    const secid = document.getElementById("secid").value;
    const currency = document.getElementById("currency").value;
    ssidList = ssid.split(",");
    secidList = secid.split(",");
    currencyList = currency.split(",");
    console.log(ssidList, secidList, currencyList);
    body = JSON.stringify(
      ssidList.map((item, index) => ({
        SSID: item,
        SECId: secidList[index],
        Currency: currencyList[index],
      }))
    );
    if (ssid === "" || secid === "" || currency === "") {
      console.log("Empty");
      alert("Enter SSID SECID and Currency");
    } else {
      constructTable();
      spinner.removeAttribute("hidden");
    }
  }
  $(document).ready(function () {
    // Set div display to block
    $(".submit").click(function () {
      $(".search").css("display", "block");
    });
  });

  async function fetchList(body) {
    const response = await fetch(
      "https://qa.omexsystems.com/omexwebsrv/api/msd/FindSymbolsByListShort",
      {
        method: "POST",
        body: body,
        headers: {
          "Content-type": "application/json; charset=UTF-8",
        },
      }
    );
    spinner.setAttribute("hidden", "");
    const data = await response.json();
    return data;
  }
  function constructHeader(list) {
    var header = $("<tr></tr>");
    for (var key in list) {
      header.append("<th>" + key + "</th>");
    }
    $("thead").append(header);
  }

  function constructBody(list) {
    for (var j = 0; j < list.length; j++) {
      var row = $("<tr></tr>");

      for (var key in list[j]) {
        console.log(key);
        row.append("<td>" + list[j][key] + "</td>");
      }
      $("tbody").append(row);
    }
  }

  function constructSearch() {
    $("table thead").append(`<tr id="search">
          <td>
            <input
              type="text"
              class="inp"
              id="myInput0"
              onkeyup="myFunction(this, 0)"
              title="Type"
              placeholder="SSID"
            />
          </td>
          <td>
            <input
              type="text"
              class="inp"
              id="myInput1"
              onkeyup="myFunction(this, 1)"
              title="Type"
              placeholder="SECId"
            />
          </td>
          <td>
            <input
              type="text"
              class="inp"
              id="myInput2"
              onkeyup="myFunction(this, 2)"
              title="Type"
              placeholder="Currency"
            />
          </td>
          <td>
            <input
              type="text"
              class="inp"
              id="myInput3"
              onkeyup="myFunction(this, 3)"
              title="Type"
              placeholder="msd_name"
            />
          </td>
          <td>
            <input
              type="text"
              class="inp"
              id="myInput4"
              onkeyup="myFunction(this, 4)"
              title="Type"
              placeholder="SECId48"
            />
          </td>
          <td>
            <input
              type="text"
              class="inp"
              id="myInput5"
              onkeyup="myFunction(this, 5)"
              title="Type"
              placeholder="SECId48Value"
            />
          </td>
          <td>
            <input
              type="text"
              class="inp"
              id="myInput6"
              onkeyup="myFunction(this, 6)"
              title="Type"
              placeholder="Country"
            />
          </td>
        </tr>`);
  }

  async function constructTable() {
    document.getElementById(
      "table"
    ).innerHTML = `<thead></thead><tbody></tbody>`;
    list = await fetchList(body);
    constructHeader(list[0]);
    constructSearch();
    constructBody(list);
  }
  let filters = ["", ""];

  function myFunction(thisInput, thisIndex) {
    filters[thisIndex] = thisInput.value.toUpperCase();

    filterTable();
  }

  function filterTable() {
    var table = document.getElementById("table");
    var rows = Object.values(table.getElementsByTagName("tr"));

    for (var rowItr = 2; rowItr < rows.length; rowItr++) {
      var row = rows[rowItr];
      var cells = Object.values(row.getElementsByTagName("td"));

      var isRowVisible = filters.every((filter, filterIndex) => {
        var cell = cells[filterIndex];
        var txtValue = cell.textContent || cell.innerText;

        return filter === "" || txtValue.toUpperCase().indexOf(filter) > -1;
      });

      row.style.display = isRowVisible ? "" : "none";
    }
  }
  document.getElementById("downloadexcel").addEventListener('click', function () {
    var table2excel = new Table2Excel();
    table2excel.export(document.querySelectorAll("#table"));
  });
 
</script>
    <script src="script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>
  <script>
    function generate() {
    var doc = new jsPDF('p', 'pt', 'letter');
    var htmlstring = '';
    var tempVarToCheckPageHeight = 0;
    var pageHeight = 0;
    pageHeight = doc.internal.pageSize.height;
    specialElementHandlers = {
        // element with id of "bypass" - jQuery style selector  
        '#bypassme': function (element, renderer) {
            // true = "handled elsewhere, bypass text extraction"  
            return true
        }
    };
    margins = {
        top: 150,
        bottom: 60,
        left: 40,
        right: 40,
        width: 600
    };
    var y = 20;
    doc.setLineWidth(2);
    doc.autoTable({
        html: '#table',
        startY: 70,
        theme: 'grid',
        styles: {
            minCellHeight: 40
        }
    })
    doc.save('FetctData.pdf');
}
  </script>
</html>